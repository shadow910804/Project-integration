@model ECommercePlatform.Models.ViewModels.ReviewListViewModel

@{
    ViewData["Title"] = "å•†å“è©•åƒ¹";
}

<div class="container">
    <h2 class="mb-4">ğŸ“‹ å•†å“è©•åƒ¹åˆ—è¡¨</h2>

    <!-- æœå°‹å’Œç¯©é¸å€åŸŸ -->
    <div class="card mb-4">
        <div class="card-header">
            <h6 class="mb-0"><i class="fas fa-search"></i> æœå°‹å’Œç¯©é¸</h6>
        </div>
        <div class="card-body">
            <form method="get" asp-action="Index">
                <div class="row g-3">
                    <!-- é—œéµå­—æœå°‹ -->
                    <div class="col-md-4">
                        <label class="form-label">é—œéµå­—æœå°‹</label>
                        <input type="text" name="keyword" value="@ViewBag.Keyword"
                               class="form-control" placeholder="æœå°‹è©•åƒ¹å…§å®¹æˆ–å•†å“åç¨±...">
                    </div>

                    <!-- è©•åˆ†ç¯©é¸ -->
                    <div class="col-md-3">
                        <label class="form-label">è©•åˆ†ç¯©é¸</label>
                        <select name="scoreFilter" class="form-select">
                            <option value="">æ‰€æœ‰è©•åˆ†</option>
                            <option value="5" selected="@(ViewBag.ScoreFilter?.ToString() == "5")">â­â­â­â­â­ 5æ˜Ÿ</option>
                            <option value="4" selected="@(ViewBag.ScoreFilter?.ToString() == "4")">â­â­â­â­â˜† 4æ˜Ÿ</option>
                            <option value="3" selected="@(ViewBag.ScoreFilter?.ToString() == "3")">â­â­â­â˜†â˜† 3æ˜Ÿ</option>
                            <option value="2" selected="@(ViewBag.ScoreFilter?.ToString() == "2")">â­â­â˜†â˜†â˜† 2æ˜Ÿ</option>
                            <option value="1" selected="@(ViewBag.ScoreFilter?.ToString() == "1")">â­â˜†â˜†â˜†â˜† 1æ˜Ÿ</option>
                        </select>
                    </div>

                    <!-- æ’åºæ–¹å¼ -->
                    <div class="col-md-3">
                        <label class="form-label">æ’åºæ–¹å¼</label>
                        <select name="sort" class="form-select">
                            <option value="latest" selected="@(ViewBag.Sort == "latest")">æœ€æ–°è©•åƒ¹</option>
                            <option value="oldest" selected="@(ViewBag.Sort == "oldest")">æœ€èˆŠè©•åƒ¹</option>
                            <option value="highscore" selected="@(ViewBag.Sort == "highscore")">é«˜åˆ†å„ªå…ˆ</option>
                            <option value="lowscore" selected="@(ViewBag.Sort == "lowscore")">ä½åˆ†å„ªå…ˆ</option>
                        </select>
                    </div>

                    <!-- æœå°‹æŒ‰éˆ• -->
                    <div class="col-md-2">
                        <label class="form-label">&nbsp;</label>
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-search"></i> æœå°‹
                            </button>
                            <a asp-action="Index" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-times"></i> æ¸…é™¤
                            </a>
                        </div>
                    </div>
                </div>

                <!-- å•†å“ç¯©é¸ (å¦‚æœæœ‰æŒ‡å®šå•†å“) -->
                @if (ViewBag.ProductId != null)
                {
                    <input type="hidden" name="productId" value="@ViewBag.ProductId">
                    <div class="row mt-3">
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="fas fa-filter"></i>
                                ç›®å‰åƒ…é¡¯ç¤ºã€Œ<strong>@ViewBag.ProductName</strong>ã€çš„è©•åƒ¹
                                <a asp-action="Index" class="btn btn-sm btn-outline-primary ms-2">
                                    <i class="fas fa-eye"></i> æŸ¥çœ‹æ‰€æœ‰è©•åƒ¹
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </form>
        </div>
    </div>

    <!-- çµ±è¨ˆè³‡è¨Š -->
    <div class="row mb-3">
        <div class="col-md-8">
            <p class="text-muted">
                ğŸ“ ç¸½è©•åƒ¹æ•¸ï¼š<strong>@Model.TotalReviews</strong> |
                â­ å¹³å‡è©•åˆ†ï¼š<strong>@Model.AverageScore.ToString("0.0")</strong>
                @if (Model.TotalItems != Model.TotalReviews)
                {
                    <span> | ğŸ” æœå°‹çµæœï¼š<strong>@Model.TotalItems</strong> å‰‡</span>
                }
            </p>

            <!-- è©•åˆ†åˆ†å¸ƒ -->
            @if (Model.RatingDistribution.Any())
            {
                <div class="rating-distribution">
                    <small class="text-muted">è©•åˆ†åˆ†å¸ƒï¼š</small>
                    @for (int i = 5; i >= 1; i--)
                    {
                        var count = Model.RatingDistribution.GetValueOrDefault(i, 0);
                        var percentage = Model.TotalReviews > 0 ? (count * 100.0 / Model.TotalReviews) : 0;
                        <span class="badge bg-light text-dark me-1">
                            @iâ­ @(count)å‰‡ (@percentage.ToString("0.0")%)
                        </span>
                    }
                </div>
            }
        </div>

        <div class="col-md-4 text-end">
            @if (User.Identity?.IsAuthenticated == true)
            {
                <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReviewModal">
                    âœï¸ æ–°å¢è©•åƒ¹
                </button>
            }
            else
            {
                <a asp-controller="Account" asp-action="Login" class="btn btn-primary">
                    ğŸ”‘ ç™»å…¥å¾Œè©•åƒ¹
                </a>
            }
        </div>
    </div>

    <!-- è©•åƒ¹åˆ—è¡¨ -->
    <div class="row" id="reviewsList">
        @if (Model.Reviews != null && Model.Reviews.Any())
        {
            @foreach (var review in Model.Reviews)
            {
                <div class="col-md-6 mb-4">
                    <div class="card h-100 shadow-sm review-card">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <div>
                                <strong>@(review.UserName ?? review.User?.Username ?? "åŒ¿åç”¨æˆ¶")</strong>
                                <small class="text-muted d-block">@review.CreatedAt.ToString("yyyy-MM-dd HH:mm")</small>
                            </div>
                            <div class="rating-display">
                                <span class="text-warning">
                                    @for (int s = 1; s <= 5; s++)
                                    {
                                        if (s <= review.Rating)
                                        {
                                            <i class="fas fa-star"></i>
                                        }
                                        else
                                        {
                                            <i class="far fa-star"></i>
                                        }
                                    }
                                </span>
                                <small class="text-muted">@review.Rating/5</small>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- å•†å“åç¨± (å¦‚æœä¸æ˜¯å–®ä¸€å•†å“é é¢) -->
                            @if (ViewBag.ProductId == null && review.Product != null)
                            {
                                <div class="mb-2">
                                    <small class="text-primary">
                                        <i class="fas fa-box"></i>
                                        <a asp-controller="Product" asp-action="Details" asp-route-id="@review.ProductId">
                                            @review.Product.Name
                                        </a>
                                    </small>
                                </div>
                            }

                            <p class="review-content">@review.Content</p>

                            @if (review.ImageData != null)
                            {
                                <div class="review-image mt-2">
                                    <img src="/reviews/image/@review.Id"
                                         class="img-fluid rounded shadow-sm"
                                         alt="è©•åƒ¹åœ–ç‰‡"
                                         style="max-height: 200px; cursor: pointer;"
                                         onclick="showImageModal(this.src)" />
                                </div>
                            }
                        </div>
                        <div class="card-footer bg-transparent">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="review-actions">
                                    @if (User.Identity?.IsAuthenticated == true)
                                    {
                                        <button class="btn btn-sm btn-outline-primary helpful-btn"
                                                data-review-id="@review.Id">
                                            <i class="fas fa-thumbs-up"></i> æœ‰å¹«åŠ©
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary report-btn"
                                                data-review-id="@review.Id"
                                                data-bs-toggle="modal"
                                                data-bs-target="#reportModal">
                                            <i class="fas fa-flag"></i> æª¢èˆ‰
                                        </button>
                                    }
                                    @if (int.Parse(User.Claims.First(c => c.Type == "UserId").Value)==review.UserId)
                                    {
                                        <button class="btn btn-sm btn-outline-primary"
                                                data-review-id="@review.Id">
                                            <i class="fas "></i> ç·¨è¼¯ç•™è¨€
                                        </button>
                                        <button class="btn btn-sm btn-outline-secondary delete-btn"
                                                data-review-id="@review.Id">
                                            <i class="fas fa-trash"></i> åˆªé™¤ç•™è¨€
                                        </button>
                                    }
                                </div>
                                <small class="text-muted">
                                    è©•åƒ¹æ™‚é–“ï¼š@review.CreatedAt.ToString("MM/dd")
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            }
        }
        else
        {
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <h5>ğŸ“­ æ²’æœ‰æ‰¾åˆ°è©•åƒ¹</h5>
                    @if (!string.IsNullOrEmpty(ViewBag.Keyword?.ToString()) || ViewBag.ScoreFilter != null)
                    {
                        <p>è«‹å˜—è©¦èª¿æ•´æœå°‹æ¢ä»¶ï¼Œæˆ– <a asp-action="Index">æŸ¥çœ‹æ‰€æœ‰è©•åƒ¹</a></p>
                    }
                    else
                    {
                        <p>æˆç‚ºç¬¬ä¸€å€‹è©•åƒ¹çš„äººå§ï¼</p>
                        @if (User.Identity?.IsAuthenticated == true)
                        {
                            <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addReviewModal">
                                ç«‹å³è©•åƒ¹
                            </button>
                        }
                        else
                        {
                            <a asp-controller="Account" asp-action="Login" class="btn btn-primary">ç™»å…¥å¾Œè©•åƒ¹</a>
                        }
                    }
                </div>
            </div>
        }
    </div>

    <!-- åˆ†é å°èˆª -->
    @if (Model.TotalPages > 1)
    {
        <nav aria-label="è©•åƒ¹åˆ†é " class="mt-4">
            <ul class="pagination justify-content-center">
                @if (Model.HasPreviousPage)
                {
                    <li class="page-item">
                        <a class="page-link" href="?page=@(Model.PageNumber - 1)&keyword=@ViewBag.Keyword&scoreFilter=@ViewBag.ScoreFilter&sort=@ViewBag.Sort&productId=@ViewBag.ProductId">
                            <i class="fas fa-chevron-left"></i> ä¸Šä¸€é 
                        </a>
                    </li>
                }

                @{
                    var startPage = Math.Max(1, Model.PageNumber - 2);
                    var endPage = Math.Min(Model.TotalPages, Model.PageNumber + 2);
                }

                @for (var i = startPage; i <= endPage; i++)
                {
                    <li class="page-item @(Model.PageNumber == i ? "active" : "")">
                        <a class="page-link" href="?page=@i&keyword=@ViewBag.Keyword&scoreFilter=@ViewBag.ScoreFilter&sort=@ViewBag.Sort&productId=@ViewBag.ProductId">@i</a>
                    </li>
                }

                @if (Model.HasNextPage)
                {
                    <li class="page-item">
                        <a class="page-link" href="?page=@(Model.PageNumber + 1)&keyword=@ViewBag.Keyword&scoreFilter=@ViewBag.ScoreFilter&sort=@ViewBag.Sort&productId=@ViewBag.ProductId">
                            ä¸‹ä¸€é  <i class="fas fa-chevron-right"></i>
                        </a>
                    </li>
                }
            </ul>
        </nav>

        <!-- åˆ†é è³‡è¨Š -->
        <div class="text-center mt-3">
            <small class="text-muted">
                é¡¯ç¤ºç¬¬ @((Model.PageNumber - 1) * Model.PageSize + 1) - @Math.Min(Model.PageNumber * Model.PageSize, Model.TotalItems) å‰‡è©•åƒ¹ï¼Œ
                å…± @Model.TotalItems å‰‡
            </small>
        </div>
    }
</div>

@* æ–°å¢è©•åƒ¹æ¨¡æ…‹æ¡† *@
@if (User.Identity?.IsAuthenticated == true)
{
    <div class="modal fade" id="addReviewModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">æ–°å¢è©•åƒ¹</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <form id="addReviewForm" enctype="multipart/form-data">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label class="form-label">è©•åˆ†ï¼š</label>
                            <select name="rating" class="form-select" required>
                                <option value="">è«‹é¸æ“‡è©•åˆ†</option>
                                <option value="5">â­â­â­â­â­ éå¸¸æ»¿æ„</option>
                                <option value="4">â­â­â­â­â˜† æ»¿æ„</option>
                                <option value="3">â­â­â­â˜†â˜† æ™®é€š</option>
                                <option value="2">â­â­â˜†â˜†â˜† ä¸æ»¿æ„</option>
                                <option value="1">â­â˜†â˜†â˜†â˜† éå¸¸ä¸æ»¿æ„</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">è©•åƒ¹å…§å®¹ï¼š</label>
                            <textarea name="content" class="form-control" rows="4" placeholder="è«‹æè¿°æ‚¨çš„ä½¿ç”¨é«”é©—..." required></textarea>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ç”¢å“IDï¼š</label>
                            <input type="number" name="productId" class="form-control" value="@(ViewBag.ProductId ?? 1)" required />
                        </div>
                        <div class="mb-3">
                            <label class="form-label">ä¸Šå‚³åœ–ç‰‡ï¼ˆå¯é¸ï¼‰ï¼š</label>
                            <input type="file" name="imageFile" class="form-control" accept="image/*" />
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                        <button type="submit" class="btn btn-success">æäº¤è©•åƒ¹</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
}

<!-- åœ–ç‰‡æ”¾å¤§æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="imageModal" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title">è©•åƒ¹åœ–ç‰‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-0">
                <img id="modalImage" src="" alt="è©•åƒ¹åœ–ç‰‡" class="img-fluid" />
            </div>
        </div>
    </div>
</div>

<!-- æª¢èˆ‰æ¨¡æ…‹æ¡† -->
<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-flag"></i> æª¢èˆ‰è©•åƒ¹</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="reportForm">
                <div class="modal-body">
                    <input type="hidden" id="reportReviewId" name="reviewId" />

                    <div class="mb-3">
                        <label class="form-label">æª¢èˆ‰åŸå› ï¼š</label>
                        <select name="reason" class="form-select" required>
                            <option value="">è«‹é¸æ“‡æª¢èˆ‰åŸå› </option>
                            <option value="spam">åƒåœ¾è¨Šæ¯</option>
                            <option value="inappropriate">ä¸ç•¶å…§å®¹</option>
                            <option value="fake">è™›å‡è©•åƒ¹</option>
                            <option value="harassment">é¨·æ“¾ä»–äºº</option>
                            <option value="other">å…¶ä»–</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">è©³ç´°èªªæ˜ï¼š</label>
                        <textarea name="description" class="form-control" rows="3"
                                  placeholder="è«‹è©³ç´°èªªæ˜æª¢èˆ‰åŸå› ..."></textarea>
                    </div>

                    <div class="form-check">
                        <input type="checkbox" name="harassment" class="form-check-input" id="harassment">
                        <label class="form-check-label" for="harassment">é¨·æ“¾</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" name="pornography" class="form-check-input" id="pornography">
                        <label class="form-check-label" for="pornography">è‰²æƒ…å…§å®¹</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" name="threaten" class="form-check-input" id="threaten">
                        <label class="form-check-label" for="threaten">å¨è„…</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" name="hatred" class="form-check-input" id="hatred">
                        <label class="form-check-label" for="hatred">ä»‡æ¨è¨€è«–</label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="submit" class="btn btn-danger">æäº¤æª¢èˆ‰</button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // æ–°å¢è©•åƒ¹
        $('#addReviewForm').submit(function(e) {
            e.preventDefault();

            const formData = new FormData(this);

            $.ajax({
                url: '@Url.Action("Create", "Review")',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                forceSync:true,
                success: function(result) {
                    if (result.success) {
                        $('#addReviewModal').modal('hide');
                        location.reload();
                    } else {
                        alert(result.message || 'æäº¤å¤±æ•—');
                    }
                },
                error: function() {
                    alert('æäº¤å¤±æ•—ï¼Œè«‹ç¨å¾Œé‡è©¦');
                }
            });
        });

        // åœ–ç‰‡æ”¾å¤§åŠŸèƒ½
        function showImageModal(imageSrc) {
            document.getElementById('modalImage').src = imageSrc;
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        //åˆå§‹åŒ–(ä¸ç­‰åœ–ç‰‡ã€css)
        document.addEventListener('DOMContentLoaded', function() {
            // æª¢èˆ‰æŒ‰éˆ•é»æ“Šäº‹ä»¶
            document.querySelectorAll('.report-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    document.getElementById('reportReviewId').value = reviewId;
                });
            });

            // æª¢èˆ‰è¡¨å–®æäº¤
            document.getElementById('reportForm').addEventListener('submit', function(e) {
                e.preventDefault();

                const formData = new FormData(this);
                const data = Object.fromEntries(formData.entries());

                // è™•ç† checkbox å€¼
                data.harassment = formData.has('harassment');
                data.pornography = formData.has('pornography');
                data.threaten = formData.has('threaten');
                data.hatred = formData.has('hatred');

                fetch('/Review/Report', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value || ''
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(result => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                    modal.hide();

                    if (result.success) {
                        alert('âœ… ' + result.message);
                    } else {
                        alert('âŒ ' + result.message);
                    }
                })
                .catch(error => {
                    console.error('æª¢èˆ‰å¤±æ•—:', error);
                    alert('âŒ æª¢èˆ‰å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦');
                });
            });


            // åˆªé™¤åŠŸèƒ½
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');
                    let DeleteCheck = confirm("ç¢ºå®šåˆªé™¤ç•™è¨€å—?");
                        alert(reviewId);
                });
            });




            // æœ‰å¹«åŠ©æŒ‰éˆ•
            document.querySelectorAll('.helpful-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const reviewId = this.getAttribute('data-review-id');

                    // é€™è£¡å¯ä»¥å¯¦ä½œæœ‰å¹«åŠ©çš„åŠŸèƒ½
                    this.classList.add('btn-primary');
                    this.classList.remove('btn-outline-primary');
                    this.innerHTML = '<i class="fas fa-thumbs-up"></i> å·²æ¨™è¨˜æœ‰å¹«åŠ©';
                    this.disabled = true;
                });
            });
        });

        // å¡ç‰‡æ‡¸åœæ•ˆæœ
        document.querySelectorAll('.review-card').forEach(card => {
            card.addEventListener('mouseenter', function() {
                this.style.transform = 'translateY(-2px)';
                this.style.transition = 'transform 0.2s ease';
            });

            card.addEventListener('mouseleave', function() {
                this.style.transform = 'translateY(0)';
            });
        });
    </script>
}

<style>
    .review-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

        .review-card:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
        }

    .rating-distribution .badge {
        font-size: 0.75em;
    }

    .review-content {
        line-height: 1.6;
    }

    .review-image img {
        transition: transform 0.2s ease;
    }

        .review-image img:hover {
            transform: scale(1.05);
        }

    /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
    @@media (max-width: 768px) {
        .review-actions

    {
        flex-direction: column;
        align-items: flex-start !important;
    }

    .review-actions .btn {
        margin-bottom: 5px;
        width: 100%;
    }

    }
</style>